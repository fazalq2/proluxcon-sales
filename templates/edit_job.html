{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <h1>Edit Job</h1>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="flash-message {{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form method="POST" action="{{ url_for('edit_job', job_id=job.id) }}" class="mt-4" style="max-width: 700px;">

    <!-- Job Number -->
    <div class="form-group mb-3">
      <label for="job_number">Job Number</label>
      <input 
        type="text" 
        class="form-control" 
        id="job_number" 
        name="job_number"
        value="{{ job.job_number }}"
      />
    </div>

    <!-- Job Name -->
    <div class="form-group mb-3">
      <label for="name">Job Name <span class="text-danger">*</span></label>
      <input 
        type="text" 
        class="form-control" 
        id="name" 
        name="name" 
        value="{{ job.name }}" 
        required
      />
    </div>

    <!-- Job Status -->
    <div class="form-group mb-3">
      <label for="status">Job Status</label>
      <select 
        class="form-select" 
        id="status" 
        name="status"
      >
        <option value="pending" {% if job.status == "pending" %} selected {% endif %}>Pending</option>
        <option value="in_progress" {% if job.status == "in_progress" %} selected {% endif %}>In Progress</option>
        <option value="completed" {% if job.status == "completed" %} selected {% endif %}>Completed</option>
        <option value="cancelled" {% if job.status == "cancelled" %} selected {% endif %}>Cancelled</option>
      </select>
    </div>

    <!-- Client Selection -->
    <div class="form-group mb-3">
      <label for="client_id">Client</label>
      <select class="form-select" id="client_id" name="client_id">
        {% for c in clients %}
          <option value="{{ c.id }}" 
            {% if c.id == job.client_id %} selected {% endif %}
          >
            {{ c.name }}
            {% if c.phone %} ({{ c.phone }}){% endif %}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- If admin, show "Assigned to" dropdown -->
    {% if sales_users and sales_users|length > 0 %}
    <div class="form-group mb-3">
      <label for="assigned_user_id">Assigned User</label>
      <select class="form-select" id="assigned_user_id" name="assigned_user_id">
        <option value="">-- No Change --</option>
        {% for user in sales_users %}
          <option 
            value="{{ user.id }}"
            {% if user.id == job.user_id %} selected {% endif %}
          >
            {{ user.name }} ({{ user.email }})
          </option>
        {% endfor %}
      </select>
      <small class="text-muted">
        Admin only: reassign this job to another sales user.
      </small>
    </div>
    {% endif %}

    <!-- Installation Address -->
    <div class="form-group mb-3">
      <label for="installation_address">Installation Address</label>
      <textarea 
        class="form-control" 
        id="installation_address" 
        name="installation_address" 
        rows="2"
      >{{ job.installation_address }}</textarea>
    </div>

    <!-- Description -->
    <div class="form-group mb-3">
      <label for="description">Description</label>
      <textarea 
        class="form-control" 
        id="description" 
        name="description" 
        rows="4"
      >{{ job.description }}</textarea>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-save"></i> Save Changes
      </button>
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
        Cancel
      </a>
    </div>
  </form>
</div>

{% endblock %}
